# MQTT 超音波距離偵測系統 - 使用說明

## 🚀 專案概述

這是一個基於 web:bit 的物聯網距離偵測系統，結合超音波感測器、MQTT 通訊和伺服馬達控制，實現即時距離監測和遠端控制功能。

## 📋 系統組件

### 硬體需求
- **web:bit v2** - 主控制板
- **HC-SR04 超音波感測器** - 距離偵測
- **SG90 伺服馬達** - 角度控制
- **連接線** - 硬體連接

### 軟體組件
- `test.py` - web:bit 端 MicroPython 程式
- `test.html` - 網頁控制介面
- `iotDevice.js` - MQTT 通訊函式庫

## 🔌 硬體連接

### 超音波感測器 (HC-SR04)
```
HC-SR04    →    web:bit
VCC        →    3.3V
GND        →    GND
Trig       →    Pin 1
Echo       →    Pin 2
```

### 伺服馬達 (SG90)
```
SG90       →    web:bit
紅線(VCC)   →    3.3V
棕線(GND)   →    GND
橘線(信號)   →    Pin 9
```

## 📱 功能特色

### 🌊 距離偵測
- **即時監測**: 每 100ms 偵測一次距離
- **智慧更新**: 距離變化超過 2cm 才更新數據
- **視覺反饋**: LED 矩陣根據距離顯示不同顏色和圖案
  - `< 10cm`: 紅色愛心 + 警告音
  - `10-30cm`: 橘色三角形
  - `30-50cm`: 綠色笑臉
  - `> 50cm`: 藍色星星

### 🎛️ 伺服馬達控制
- **自動模式**: 根據距離自動調整角度
  - 距離 < 20cm → 45° (向左)
  - 距離 20-40cm → 90° (居中)
  - 距離 > 40cm → 135° (向右)
- **手動控制**: 
  - 按鈕 A: 向左轉 15°
  - 按鈕 B: 向右轉 15°
  - 按鈕 A+B: 重置到 90°
- **網頁控制**: 透過滑桿設定 0-180° 任意角度

### 📡 MQTT 通訊
- **傳送距離**: `yyy/distance` 主題
- **接收控制**: `yyy/servo` 主題
- **訊息格式**: JSON 格式，符合 IoTDevice 標準

## 🌐 網頁介面功能

### 顯示功能
- **即時距離**: 大型數字顯示當前距離
- **連線狀態**: 顯示 MQTT 連線狀態
- **操作記錄**: 時間戳記的操作歷史

### 控制功能
- **連線管理**: 連接/斷開 MQTT
- **馬達控制**: 0-180° 角度滑桿控制
- **即時反饋**: 所有操作都有即時回饋

## 🚀 快速開始

### 1. 硬體設置
1. 按照連接圖連接所有硬體組件
2. 確保所有連接穩固可靠

### 2. 程式上傳
1. 將 `test.py` 上傳到 web:bit
2. 重新啟動 web:bit

### 3. 網頁運行
1. 確保 `test.html` 和 `iotDevice.js` 在同一目錄
2. 在支援 HTTPS 的網頁伺服器上運行
3. 開啟瀏覽器訪問 `test.html`

### 4. 開始使用
1. 網頁會自動嘗試連接 MQTT
2. web:bit 啟動後會顯示綠色笑臉
3. 開始偵測距離並在網頁上顯示

## 🔧 MQTT 設定

### 伺服器資訊
- **Broker**: `wss://mqtt-edu.webduino.io/mqtt`
- **帳號**: `hsh2025`
- **密碼**: `hsh2025`
- **設備 ID**: `yyy`

### 主題格式
```javascript
// 距離數據 (web:bit → 網頁)
Topic: "yyy/distance"
Payload: {
    "requestId": "req-12345",
    "from": "webbit-device", 
    "payload": {
        "distance": 25
    }
}

// 馬達控制 (網頁 → web:bit)
Topic: "yyy/servo"  
Payload: {
    "requestId": "req-67890",
    "from": "yyy",
    "payload": {
        "angle": 90
    }
}
```

## 🎮 操作指南

### web:bit 按鈕操作
- **按鈕 A**: 伺服馬達向左轉 15°
- **按鈕 B**: 伺服馬達向右轉 15°  
- **按鈕 A+B**: 重置伺服馬達到 90° (中心位置)

### 網頁操作
- **連接按鈕**: 建立 MQTT 連線
- **斷開按鈕**: 中斷 MQTT 連線
- **角度滑桿**: 即時控制伺服馬達角度 (0-180°)

## 🐛 故障排除

### 常見問題

**1. 網頁無法連接 MQTT**
- 確認網路連線正常
- 檢查瀏覽器是否支援 WebSocket
- 確認使用 HTTPS 協定

**2. 距離數據不準確**
- 檢查超音波感測器連接
- 確認障礙物在感測範圍內 (2-400cm)
- 避免感測器面對吸音材質

**3. 伺服馬達不轉動**
- 檢查電源供應是否足夠
- 確認連接線沒有鬆脫
- 檢查角度是否在有效範圍 (0-180°)

**4. MQTT 訊息丟失**
- 檢查網路穩定性
- 確認 MQTT Broker 正常運作
- 重新啟動設備和網頁

### 除錯模式
web:bit 會在序列埠輸出詳細除錯訊息，包括：
- 距離偵測值
- MQTT 訊息內容
- 錯誤訊息
- 系統狀態

## 📊 系統監控

### 狀態指示
- **LED 矩陣**: 即時顯示距離狀態
- **序列埠**: 詳細系統資訊
- **網頁記錄**: 操作歷史記錄

### 效能監控
- **溫度監測**: 每 5 秒檢查系統溫度
- **距離更新**: 僅在變化 > 2cm 時更新
- **角度優化**: 僅在變化 > 10° 時調整

## 🔮 擴展功能

### 可能的改進
1. **多感測器支援**: 整合溫濕度、光線感測器
2. **資料記錄**: 將歷史數據儲存到資料庫
3. **警報系統**: 設定距離閾值警報
4. **語音控制**: 整合語音指令功能
5. **移動端 App**: 開發手機應用程式

### 自訂設定
可以修改程式中的參數來客製化行為：
- 距離偵測頻率
- 距離變化閾值  
- 自動角度調整邏輯
- LED 顯示效果
- 音效提示

## 📄 授權資訊

本專案採用開源授權，歡迎自由使用和修改。

---

**�� 享受您的 IoT 距離偵測系統！** 